[testenv:test-pyppeteer]
setenv =
    # See https://docs.djangoproject.com/en/4.0/topics/async/#envvar-DJANGO_ALLOW_ASYNC_UNSAFE
    DJANGO_ALLOW_ASYNC_UNSAFE = true
    # This is necessary for the Django dev server to behave correctly
    DJANGO_CONFIGURATION = PyppeteerTestingConfiguration
    PYPPETEER_TEST_CLIENT_COMMAND=npm run serve
    PYPPETEER_TEST_CLIENT_DIR=web_client
    # nodeversion >=17 deprecated some OpenSSL algorithms which a dependency is still using
    # https://nodejs.org/en/blog/release/v17.0.0/
    PYPPETEER_NODE_OPTIONS=--openssl-legacy-provider
    # This differs from the cookiecutter default PYPPETEER_VUE_APP_API_ROOT, so we need to set it manually
    # See https://girder-pytest-pyppeteer.readthedocs.io/en/latest/pytest_plugin/#webpack_server
    PYPPETEER_VUE_APP_API_URL=\{live_server\}/api/v1
    # I had to set this to get the browser window to show up in Ubuntu 20.04
    DISPLAY=:1
passenv =
    DJANGO_CELERY_BROKER_URL
    DJANGO_DATABASE_URL
    DJANGO_MINIO_STORAGE_ACCESS_KEY
    DJANGO_MINIO_STORAGE_ENDPOINT
    DJANGO_MINIO_STORAGE_SECRET_KEY
    DJANGO_STORAGE_BUCKET_NAME
    PYPPETEER_BROWSER_HEADLESS
extras =
    dev
    learning
    zarr
deps =
    factory-boy
    girder-pytest-pyppeteer[pyppeteer]
    pytest
    pytest-cov
    pytest-django
    pytest-factoryboy
    pytest-mock
commands =
    pytest -m pyppeteer {posargs:--cov=miqa --cov-report=xml}
